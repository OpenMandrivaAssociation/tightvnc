From f9f98107f8aca68c3fe0c050f1bc5aedf463be8b Mon Sep 17 00:00:00 2001
From: Paulo Zanoni <pzanoni@mandriva.com>
Date: Wed, 22 Dec 2010 17:17:57 -0200
Subject: [PATCH 1/6] CVE-2007-1003

---
 Xvnc/programs/Xserver/Xext/xcmisc.c |   13 +++++++++++--
 1 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/Xvnc/programs/Xserver/Xext/xcmisc.c b/Xvnc/programs/Xserver/Xext/xcmisc.c
index 099b8d4..fee66d2 100644
--- a/Xvnc/programs/Xserver/Xext/xcmisc.c
+++ b/Xvnc/programs/Xserver/Xext/xcmisc.c
@@ -41,6 +41,12 @@ from the X Consortium.
 #include "swaprep.h"
 #include "xcmiscstr.h"
 
+#if HAVE_STDINT_H
+#include <stdint.h>
+#elif !defined(UINT32_MAX)
+#define UINT32_MAX 0xffffffffU
+#endif
+
 static unsigned char XCMiscCode;
 
 static void XCMiscResetProc(
@@ -135,7 +141,10 @@ ProcXCMiscGetXIDList(client)
 
     REQUEST_SIZE_MATCH(xXCMiscGetXIDListReq);
 
-    pids = (XID *)ALLOCATE_LOCAL(stuff->count * sizeof(XID));
+    if (stuff->count > UINT32_MAX / sizeof(XID))
+	    return BadAlloc;
+
+    pids = (XID *)Xalloc(stuff->count * sizeof(XID));
     if (!pids)
     {
 	return BadAlloc;
@@ -156,7 +165,7 @@ ProcXCMiscGetXIDList(client)
     	client->pSwapReplyFunc = (ReplySwapPtr) Swap32Write;
 	WriteSwappedDataToClient(client, count * sizeof(XID), pids);
     }
-    DEALLOCATE_LOCAL(pids);
+    Xfree(pids);
     return(client->noClientException);
 }
 
-- 
1.7.1

