From a235ccaf235d92f11289f59c211e13a5652efce2 Mon Sep 17 00:00:00 2001
From: Paulo Zanoni <pzanoni@mandriva.com>
Date: Wed, 22 Dec 2010 17:19:03 -0200
Subject: [PATCH 2/6] CVE-2007-1351-1352

---
 Xvnc/lib/font/bitmap/bdfread.c   |   11 +++++++++++
 Xvnc/lib/font/fontfile/fontdir.c |    8 ++++++++
 2 files changed, 19 insertions(+), 0 deletions(-)

diff --git a/Xvnc/lib/font/bitmap/bdfread.c b/Xvnc/lib/font/bitmap/bdfread.c
index 09d9e61..1063ba1 100644
--- a/Xvnc/lib/font/bitmap/bdfread.c
+++ b/Xvnc/lib/font/bitmap/bdfread.c
@@ -59,6 +59,12 @@ from the X Consortium.
 #include "bitmap.h"
 #include "bdfint.h"
 
+#if HAVE_STDINT_H
+#include <stdint.h>
+#elif !defined(INT32_MAX)
+#define INT32_MAX 0x7fffffff
+#endif
+
 #define INDICES 256
 #define MAXENCODING 0xFFFF
 #define BDFLINELEN  1024
@@ -271,6 +277,11 @@ bdfReadCharacters(file, pFont, pState, bit, byte, glyph, scan)
 	bdfError("invalid number of CHARS in BDF file\n");
 	return (FALSE);
     }
+    if (nchars > INT32_MAX / sizeof(CharInfoRec)) {
+	bdfError("Couldn't allocate pCI (%d*%d)\n", nchars,
+		 sizeof(CharInfoRec));
+	goto BAILOUT;
+    }
     ci = (CharInfoPtr) xalloc(nchars * sizeof(CharInfoRec));
     if (!ci) {
 	bdfError("Couldn't allocate pCI (%d*%d)\n", nchars,
diff --git a/Xvnc/lib/font/fontfile/fontdir.c b/Xvnc/lib/font/fontfile/fontdir.c
index a763e3c..9576923 100644
--- a/Xvnc/lib/font/fontfile/fontdir.c
+++ b/Xvnc/lib/font/fontfile/fontdir.c
@@ -35,11 +35,19 @@ in this Software without prior written authorization from the X Consortium.
 #include    "fntfilst.h"
 #include    <X11/keysym.h>
 
+#if HAVE_STDINT_H
+#include <stdint.h>
+#elif !defined(INT32_MAX)
+#define INT32_MAX 0x7fffffff
+#endif
+
 Bool
 FontFileInitTable (table, size)
     FontTablePtr    table;
     int		    size;
 {
+    if (size < 0 || (size > INT32_MAX/sizeof(FontEntryRec)))
+	return FALSE;
     if (size)
     {
 	table->entries = (FontEntryPtr) xalloc(sizeof(FontEntryRec) * size);
-- 
1.7.1

